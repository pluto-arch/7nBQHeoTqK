<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;"><blockquote class="multiquote-1" data-tool="mdnice编辑器" style="border: none; display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); background: rgba(0, 0, 0, 0.05); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">手把手教你搭建Gitlab、Docker、Docker-compose CI/CD</p>
</blockquote>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">作为一个开发人员，怎么提高自己的效率是很关键的，那么CI/CD就是其中很关键的一环，Gitlab作为一个强大的代码托管平台，也拥有强大的CI/CD功能，并且每个月都有一定的免费分钟数供大家使用，本文将基于实际项目来讲解如何搭建一个Gitlab+Docker+Docker-Compose 的完整流水线。无论你突是新手还是需要此类功能进行快速叫交付的团队，都能从中收获不少。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: none;"></span><span class="content">环境准备</span><span class="suffix"></span></h2>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">准备服务器</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">这里我们准备一台ubuntu服务器。需要设置SSH访问。所以用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">putty key generator</code>开生成SSH公私钥。
下载安装<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Putty</code> 后打开 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">key generator</code>直接点击生成即可</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20240729/20240729182931481.gif" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">接下来是将上边步骤生成的公钥，也就是 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">ssh-ras XXXXX</code> 这一串内容复制，打开服务器远程，执行以下命令:</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">cd&nbsp;~/.ssh<br>vim&nbsp;authorized_keys<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">打开文件后将上边PUTTY生成的公钥粘贴进去即可。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">最后还需要将私钥导出问OpenSSH格式：</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20240729/20240729183534397.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">新建Gitlab项目组</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">首先，需要去gitlab官网注册一个账号，关于注册账号的过程就不多赘述了，相信大多数开发者都有账号。账号注册好之后，我们创建一个项目组</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20240729/20240729182353835.png" alt="示例项目组" style="display: block; margin: 0 auto; max-width: 100%;"><figcaption style="margin-top: 5px; text-align: center; color: #888; font-size: 14px;">示例项目组</figcaption></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">创建好项目组之后，我们先得配置环境变量，点击刚刚创建的Group。然后进入Settings-&gt; CICD</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20240729/20240729183658486.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">打开Variables，配置以下四个环境变量，一个是远程服务器ip，一个SSH端口(默认的话就可以不用配置)，SSH用户以及私钥，这个私钥就是前边步骤使用PUTTY生成后导出的OpenSSH私钥文件，直接粘贴私钥内容即可。</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20240729/20240729183724050.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">这样前置条件就配置好了。接下来就是配置CI/CD模板</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">配置CICD模板仓库</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">接下来在上边新建的项目组中新一个代码仓库，命名为<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">ci_cd_template</code>.然后直接在网页上边编辑。</p>
<blockquote class="multiquote-1" data-tool="mdnice编辑器" style="border: none; display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); background: rgba(0, 0, 0, 0.05); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">我们这边以dotnet项目cicd为例
此模板仓库文件内容如下</p>
</blockquote>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20240729/20240729184121241.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content"><code>init.yml</code></span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">这个文件是初始化阶段，用来将以下传入的变量写入环境中，内容如下：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stages:</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">init</span><br><br><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">init-job:</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stage:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">init</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">script:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;这里的$&nbsp;开头的就是流水线变量，可以自定义，也可以使用平台预定义的</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_PROJECT_NAME=$CI_PROJECT_NAME"</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">&gt;&gt;</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">init.env</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_PROJECT_PATH=$CI_PROJECT_PATH"</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">&gt;&gt;</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">init.env</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_COMMIT_HASH=$CI_COMMIT_SHA"</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">&gt;&gt;</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">init.env</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_USER_NAME=$GITLAB_USER_NAME"</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">&gt;&gt;</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">init.env</span><br>&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;设置工件，过期时间1小时</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">artifacts:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">paths:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">init.env</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">expire_in:</span>&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">hour</span><br></code></pre>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">Jobs 具体的执行job</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">我这里将job分为三个步骤：</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">dotnet 构建和发布</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">docker镜像构建</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">服务器部署</section></li></ul>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><strong style="font-weight: bold; color: black;">dotnet 构建和发布</strong>
这里主要是对dotnet项目进行build和publish。前置条件是使用 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">mcr.microsoft.com/dotnet/sdk:8.0</code>镜像，这个可以根据自己实际项目进行选择，</section></li></ol>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stages:</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">dotnet-build-publish</span><br><br><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">dotnet-build-publish-job:</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stage:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">dotnet-build-publish</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">image:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">mcr.microsoft.com/dotnet/sdk:8.0</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">needs:</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">job:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">init-job</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">artifacts:</span>&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">cache:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">key:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">${CI_COMMIT_REF_SLUG}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">paths:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">~/.nuget/packages/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">~/.dotnet/</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">script:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_PROJECT_NAME=$CI_PROJECT_NAME"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_PROJECT_PATH=$CI_PROJECT_PATH"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_COMMIT_HASH=$CI_COMMIT_HASH"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_USER_NAME=$CI_USER_NAME"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"building&nbsp;project：&nbsp;$PROJECT_CSPROJ_PATH"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">dotnet</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">restore</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$PROJECT_CSPROJ_PATH</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;构建入口csproj</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">dotnet</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">build</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$PROJECT_CSPROJ_PATH</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-c</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">Release</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;发布项目，输出到./publish目录</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">dotnet</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">publish</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$PROJECT_CSPROJ_PATH</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-c</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">Release</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-o</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">./publish</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">/p:PublishSingleFile=true</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">cd</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">./publish</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">artifacts:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">paths:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">./publish</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">expire_in:</span>&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">hour</span><br></code></pre>
<ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><strong style="font-weight: bold; color: black;">Docker镜像构建</strong>
这里先讲一下镜像仓库，Gitlab中可以使用自带的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Container Register</code>。方便快捷，直接和流水线集成。每个代码仓库中在<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Deploy</code>-&gt;<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Container Register</code>下就可以看到。
那么如何构建呢，具体配置如下：</section></li></ol>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">这个步骤使用的基础镜像是<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">docker</code>。而且必须添加服务：<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">docker:dind</code>才能执行docker build命令</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stages:</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker-image-build</span><br><br><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">variables:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;容器注册表的登录凭据，GitLab&nbsp;提供的默认变量</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">IMAGE_NAME:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_PROJECT_PATH/$CD_IMAGE_NAME</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;使用分支名称作为标签</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">IMAGE_TAG:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"</span>&nbsp;<br><br><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">docker-image-build-job:</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stage:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker-image-build</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">image:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">needs:</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">job:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">dotnet-build-publish-job</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">artifacts:</span>&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">services:</span>&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;配置依赖服务</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker:dind</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">script:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_DOCKERFILE_PATH=$CI_DOCKERFILE_PATH"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CI_REGISTRY=$CI_REGISTRY"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"IMAGE_NAME=$IMAGE_NAME"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;登录docker&nbsp;这里都是流水线自带的变量</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"$CI_REGISTRY_PASSWORD"</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">|</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">login</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_REGISTRY</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-u</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_REGISTRY_USER</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">--password-stdin</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;使用dockerfile构建进项</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">build</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-f</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_DOCKERFILE_PATH</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-t</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_REGISTRY/$IMAGE_NAME:$IMAGE_TAG</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;推送镜像到Container&nbsp;register</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">push</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_REGISTRY/$IMAGE_NAME:$IMAGE_TAG</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"IMAGE_TAG=$IMAGE_TAG"</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">&gt;&gt;</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">image.env</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">artifacts:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">paths:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">image.env</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">expire_in:</span>&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">hour</span><br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">镜像构建完毕后会将镜像放在<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Container Register</code>中</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20240729/20240729191259894.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><strong style="font-weight: bold; color: black;">服务器部署</strong></section></li></ol>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">首先，使用docker-compose 部署的话，需要指定镜像，我们每次执行流水线的时候，都会构建一个新版本，所以需要动态更新docker-compose中的image值。那么就需要指定能够进行字符串替换的基础镜像，这里使用ubuntu:latest基础镜像。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">还有一个重要的点，就是需要加载SSH私钥，所以在此步骤中有个前置脚本<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">before_script</code>用来加载私钥。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stages:</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">digitalocean-ec-docker-deploy</span><br><br><br><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">variables:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;容器注册表的登录凭据</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">IMAGE_NAME:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_PROJECT_PATH/$CD_IMAGE_NAME</span>&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;GitLab&nbsp;提供的默认变量</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">IMAGE_TAG:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"</span>&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;使用分支名称作为标签</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">APP_NAME:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_APP_NAME</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;SSH&nbsp;地址</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">SSH_USER_AND_HOST:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">${SSH_HOST_USER}@${SSH_HOST_IP}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;$CI_REGISTRY/$IMAGE_NAME:$IMAGE_TAG</span><br><br><br><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">digitalocean-ec-docker-deploy-job:</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stage:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">digitalocean-ec-docker-deploy</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">image:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">ubuntu:latest</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">needs:</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">job:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker-image-build-job</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">artifacts:</span>&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span><br>&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;前置脚本，加载SSH私钥文件</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">before_script:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'which&nbsp;ssh-agent&nbsp;||&nbsp;(&nbsp;apt-get&nbsp;update&nbsp;-y&nbsp;&amp;&amp;&nbsp;apt-get&nbsp;install&nbsp;openssh-client&nbsp;-y&nbsp;)'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">eval</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$(ssh-agent</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-s)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">mkdir</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-p</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">~/.ssh</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"$SSH_PRIVATE_KEY"</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">|</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">tr</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-d</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'\r'</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">&gt;</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">~/.ssh/test.pem</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">chmod</span>&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">600</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">~/.ssh/test.pem</span><br><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">script:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;备份</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">|-<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssh&nbsp;-p&nbsp;${SSH_HOST_PORT}&nbsp;-o&nbsp;StrictHostKeyChecking=no&nbsp;-i&nbsp;~/.ssh/test.pem&nbsp;${SSH_USER_AND_HOST}&nbsp;&lt;&lt;&nbsp;EOF<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">if</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">[</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">!</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-d</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">/usr/apps/${APP_NAME}</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">];</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">sudo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">mkdir</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">/usr/apps/${APP_NAME}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">fi</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">cd</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">/usr/apps/${APP_NAME}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">if</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">[</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-f</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker-compose.yml</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">];</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">sudo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">mv</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker-compose.yml</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker-compose-backup.yml</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">fi</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">EOF</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;复制文件到服务器</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;sudo&nbsp;mv&nbsp;/home/ubuntu/docker-compose.yml&nbsp;/usr/apps/${APP_NAME}/docker-compose.yml</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">scp</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-P</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">${SSH_HOST_PORT}</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-o</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">StrictHostKeyChecking=no</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-i</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">~/.ssh/test.pem</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker-compose-${APP_NAME}.yml</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">${SSH_USER_AND_HOST}:/usr/apps/${APP_NAME}/docker-compose.yml</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">|-<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssh&nbsp;-p&nbsp;${SSH_HOST_PORT}&nbsp;-o&nbsp;StrictHostKeyChecking=no&nbsp;-i&nbsp;~/.ssh/test.pem&nbsp;${SSH_USER_AND_HOST}&nbsp;&lt;&lt;&nbsp;EOF<br></span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"开始登录"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"$CI_JOB_TOKEN"</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">|</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">sudo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">login</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_REGISTRY</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-u</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_REGISTRY_USER</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">--password-stdin</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">echo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"开始拉去镜像：$CI_REGISTRY/$IMAGE_NAME:$IMAGE_TAG&nbsp;"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">sudo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">pull</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$CI_REGISTRY/$IMAGE_NAME:$IMAGE_TAG</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">cd</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">/usr/apps/${APP_NAME}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;这里就是动态替换docker-compose文件中最新的image值</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">sudo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">sed</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-i</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"s|image:&nbsp;.*|image:&nbsp;$CI_REGISTRY/$IMAGE_NAME:$IMAGE_TAG|"</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker-compose.yml</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">sudo</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">compose</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">up</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">-d</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">EOF</span><br></code></pre>
<h5 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 16px;"><span class="prefix" style="display: none;"></span><span class="content"><strong style="font-weight: bold; color: black;">dotnet-deploy.yml 入口文件</strong></span><span class="suffix" style="display: none;"></span></h5>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">这里就是cicd入口配置，定义了阶段以及对应阶段的具体配置文件。并且job可以自定义，比如增加secret扫描、代码扫描、单元测试等等更加丰富的流程。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stages:</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">init</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">dotnet-build-publish</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">docker-image-build</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">digitalocean-ec-docker-deploy</span><br><br><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">include:</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">local:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'init.yml'</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">local:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'jobs/dotnet-build-publish-job.yml'</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">local:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'jobs/docker-image-build-job.yml'</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">local:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'jobs/digitalocean-ec-docker-deploy-job.yml'</span><br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">以上就是整个cicd模板。原理就是，首先使用实际项目中的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">dockerfile</code>进行镜像构建，然后将项目中<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">docker-compose</code>文件替换image值为最新的tag。在上传到服务器，然后在服务器执行 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">docker compose up -d</code>命令。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">配置项目</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">在实际项目中新建<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">.gitlab-ci.yml</code>文件、<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Dockerfile</code>文件、<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Docker-Compose.yml</code>文件
<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Dockerfile</code>和<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Docker-Compose.yml</code>文件根据自己项目的实际情况配置。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">.gitlab-ci.yml</code>文件：</p>
<blockquote class="multiquote-1" data-tool="mdnice编辑器" style="border: none; display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); background: rgba(0, 0, 0, 0.05); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">我这里设置的是手动出触发。也可以使用自动触发，可以设置Rules来指定不同的触发规则。比如dev分支触发dev cicd，main分支触发生产环境cicd等。</p>
</blockquote>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stages:</span><br>&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">manual-cicd</span><br><br><span class="hljs-attr" style="color: #d19a66; line-height: 26px;">mvc-job:</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">stage:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">manual-cicd</span><br>&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;手动出发</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">when:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">manual</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">variables:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;指定build和pubish的项目文件</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">PROJECT_CSPROJ_PATH:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"src/PlutoBlog.Mvc/PlutoBlog.Mvc.csproj"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;指定dockerfile文件</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">CI_DOCKERFILE_PATH:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"src/PlutoBlog.Mvc/Dockerfile"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;应用名称</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">CI_APP_NAME:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"blogmvc"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;镜像名称</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">CD_IMAGE_NAME:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"blogmvc"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;dotnet&nbsp;publish的目录</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">PUBLISH_DIR:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"./publish"</span><br>&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;触发器，用于触发主的cicd模板仓库流水线</span><br>&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">trigger:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">include:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;指定cicd模板仓库地址</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-bullet" style="color: #61aeee; line-height: 26px;">-</span>&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">project:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'dotnetydd.com/ci_cd_template'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;指定分支</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">ref:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">main</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">#&nbsp;指定入口yml文件</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr" style="color: #d19a66; line-height: 26px;">file:</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'/dotnet-deploy.yml'</span><br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">以上配置增加后，每次提交代码，都可以手动在<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Build</code>-&gt;<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Pipelines</code>中找到流水线
<img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20240729/20240729190504421.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">最终的执行效果如下：</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20240729/20240729190604806.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
</section>
